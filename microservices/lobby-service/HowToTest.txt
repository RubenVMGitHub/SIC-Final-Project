Testing the Lobby Service Endpoints

1. Setup - Get Authentication Token
First, register and login to get a token:
# Register a user
curl -X POST http://localhost:3000/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "player1@test.com",
    "password": "pass123",
    "displayName": "Player One",
    "favouriteSport": "Football"
  }'

# Login and save token
TOKEN=$(curl -X POST http://localhost:3000/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "player1@test.com",
    "password": "pass123"
  }' | jq -r '.token')

echo "Token: $TOKEN"

2. Create a Lobby (Owner)
# Create a lobby
LOBBY_ID=$(curl -X POST http://localhost:3000/lobbies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "sport": "Football",
    "location": "Central Park",
    "time": "2026-01-20T18:00:00Z",
    "maxPlayers": 10,
    "description": "Friendly football match, all levels welcome!"
  }' | jq -r '._id')

echo "Lobby ID: $LOBBY_ID"

3. Test Invalid Sport (Should Return 400)
# Try to create lobby with invalid sport
curl -X POST http://localhost:3000/lobbies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "sport": "InvalidSport",
    "location": "Park",
    "time": "2026-01-20T18:00:00Z",
    "maxPlayers": 10
  }'

4. Get All Lobbies (No Auth Required)
# Get all open lobbies
curl http://localhost:3000/lobbies

5. Filter Lobbies by Sport
# Filter by Football
curl "http://localhost:3000/lobbies?sport=Football" | jq

# Filter by Basketball
curl "http://localhost:3000/lobbies?sport=Basketball" | jq

# Try invalid sport filter (should return 400)
curl "http://localhost:3000/lobbies?sport=InvalidSport"

6. Get Specific Lobby by ID
# Get lobby details
curl http://localhost:3000/lobbies/$LOBBY_ID | jq

7. Update Lobby (Owner Only)
# Update only location
curl -X PUT http://localhost:3000/lobbies/$LOBBY_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "location": "Stadium A"
  }' | jq

# Update multiple fields
curl -X PUT http://localhost:3000/lobbies/$LOBBY_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "location": "Main Stadium",
    "maxPlayers": 12,
    "description": "Updated: Competitive match"
  }' | jq

# Update sport
curl -X PUT http://localhost:3000/lobbies/$LOBBY_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "sport": "Basketball"
  }' | jq

8. Join Lobby (As Another User)
# Register second user
curl -X POST http://localhost:3000/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "player2@test.com",
    "password": "pass123",
    "displayName": "Player Two"
  }'

# Login as second user
TOKEN2=$(curl -X POST http://localhost:3000/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "player2@test.com",
    "password": "pass123"
  }' | jq -r '.token')

# Join the lobby
curl -X POST http://localhost:3000/lobbies/$LOBBY_ID/join \
  -H "Authorization: Bearer $TOKEN2" \
  -H "Content-Type: application/json" \
  -d '{
    "displayName": "Player Two"
  }' | jq

# Try to join again (should return 400 - already in lobby)
curl -X POST http://localhost:3000/lobbies/$LOBBY_ID/join \
  -H "Authorization: Bearer $TOKEN2" \
  -H "Content-Type: application/json" \
  -d '{
    "displayName": "Player Two"
  }'

9. Leave Lobby
# Leave the lobby
curl -X POST http://localhost:3000/lobbies/$LOBBY_ID/leave \
  -H "Authorization: Bearer $TOKEN2" | jq

# Try to leave again (should return 400 - not in lobby)
curl -X POST http://localhost:3000/lobbies/$LOBBY_ID/leave \
  -H "Authorization: Bearer $TOKEN2"

10. Kick Player (Owner Only)
# First, player 2 joins again
curl -X POST http://localhost:3000/lobbies/$LOBBY_ID/join \
  -H "Authorization: Bearer $TOKEN2" \
  -H "Content-Type: application/json" \
  -d '{
    "displayName": "Player Two"
  }'

# Get player 2's user ID
PLAYER2_ID=$(curl -X POST http://localhost:3000/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "player2@test.com",
    "password": "pass123"
  }' | jq -r '.user.id')

# Owner kicks player 2
curl -X DELETE http://localhost:3000/lobbies/$LOBBY_ID/players/$PLAYER2_ID \
  -H "Authorization: Bearer $TOKEN" | jq

# Try to kick as non-owner (should return 403)
curl -X DELETE http://localhost:3000/lobbies/$LOBBY_ID/players/$PLAYER2_ID \
  -H "Authorization: Bearer $TOKEN2"

11. Finish Lobby (Owner Only)
# Finish the lobby
curl -X PUT http://localhost:3000/lobbies/$LOBBY_ID/finish \
  -H "Authorization: Bearer $TOKEN" | jq

# Try to finish as non-owner (should return 403)
curl -X PUT http://localhost:3000/lobbies/$LOBBY_ID/finish \
  -H "Authorization: Bearer $TOKEN2"

# Try to finish already finished lobby (should return 400)
curl -X PUT http://localhost:3000/lobbies/$LOBBY_ID/finish \
  -H "Authorization: Bearer $TOKEN"

12. Delete/Cancel Lobby (Owner Only)
# Create a new lobby for deletion test
NEW_LOBBY_ID=$(curl -X POST http://localhost:3000/lobbies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "sport": "Tennis",
    "location": "Tennis Court 1",
    "time": "2026-01-21T10:00:00Z",
    "maxPlayers": 4
  }' | jq -r '._id')

# Delete the lobby
curl -X DELETE http://localhost:3000/lobbies/$NEW_LOBBY_ID \
  -H "Authorization: Bearer $TOKEN" | jq

# Try to delete as non-owner (should return 403)
curl -X DELETE http://localhost:3000/lobbies/$LOBBY_ID \
  -H "Authorization: Bearer $TOKEN2"

13. Test Error Scenarios
# Test without authentication (should return 401)
curl -X POST http://localhost:3000/lobbies \
  -H "Content-Type: application/json" \
  -d '{
    "sport": "Football",
    "location": "Park",
    "time": "2026-01-20T18:00:00Z",
    "maxPlayers": 10
  }'

# Test with invalid lobby ID (should return 400)
curl http://localhost:3000/lobbies/invalid-id

# Test with non-existent lobby ID (should return 404)
curl http://localhost:3000/lobbies/507f1f77bcf86cd799439011

# Test missing required fields (should return 400)
curl -X POST http://localhost:3000/lobbies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "sport": "Football"
  }'